<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Services</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
			integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

		<link rel="shortcut icon" href="https://static.wikia.nocookie.net/gtawiki/images/3/32/LSSD.png">
	</head>

	<body>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
			crossorigin="anonymous"></script>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"
			integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg=="
			crossorigin="anonymous" referrerpolicy="no-referrer"></script>

		<nav class="navbar bg-body-tertiary">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">
					<img src="https://static.wikia.nocookie.net/gtawiki/images/3/32/LSSD.png" alt="Bootstrap" width="30">
					<span class="navbar-brand mb-0 h1" id="title">Heures de services</span>
				</a>
				<button type="button" class="btn btn-primary" id="btn-modal" data-bs-toggle="modal" data-bs-target="#account-modal">
					Mon compte
				</button>
			</div>
		</nav>
		<div style="padding-bottom: 2em;"></div>

		<div class="container">
			<div class="row">
				<div class="alert alert-danger" role="alert" id="no-rpname">
					Vous n'avez pas mis votre <a href="#!" data-bs-toggle="modal" data-bs-target="#account-modal" class="text-danger">nom RP</a>. Cliquez sur "Mon Compte" pour le faire.
				</div>
			</div>
		</div>

		{{{body}}}

		<div style="padding-top: 5em;"></div>
		<nav class="navbar bg-body-tertiary">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">Connecté en temps que {{user.username}}</a>
				<span class="navbar-text">
					Version {{getGitCommit}}
				</span>
			</div>
		</nav>

		<div class="modal fade" id="account-modal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="accountLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="accountLabel">Mon Compte</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<form>
						<div class="modal-body">
							<div class="input-group mb-3">
								<input type="number" class="form-control" placeholder="Matricule" aria-label="Matricule" name="matricule"
									style="flex: 0 1 150px;" min="200" max="299">
								<span class="input-group-text">|</span>
								<input type="text" class="form-control" placeholder="Nom prénom" aria-label="Nom prénom" name="identity">
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							<button type="submit" class="btn btn-primary" id="account-submit">Save changes</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div class="toast-container position-fixed p-3 top-0 end-0">		
			<div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
				<div class="toast-header">
					<svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg"
						aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false">
						<rect width="100%" height="100%" fill="#00ff00"></rect>
					</svg>
					<strong class="me-auto">Modification sauvegardée avec succès</strong>
					<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
				</div>
				<div class="toast-body" id="toast-body-success">
				</div>
			</div>

			<div id="err-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
				<div class="toast-header">
					<svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg"
						aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false">
						<rect width="100%" height="100%" fill="#ff0000"></rect>
					</svg>
					<strong class="me-auto">Une erreur est survenue</strong>
					<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
				</div>
				<div class="toast-body" id="toast-body-err">
				</div>
			</div>
		</div>
	
		<script>
			const user = {{{json user}}}
			const isAuthenticated = {{{isAuthenticated}}}

			console.log("auth ?", isAuthenticated)
		</script>

		<script defer>
			const myModal = document.getElementById('account-modal')
			const myInput = document.getElementById('btn-modal')

			myModal.addEventListener('shown.bs.modal', () => {
				myInput.focus()
			})

			const submitButton = document.getElementById('account-submit')
			const matriculeInput = document.querySelector('input[name="matricule"]')
			const identityInput = document.querySelector('input[name="identity"]')

			submitButton.addEventListener('click', async (event) => {
				event.preventDefault()
				const matricule = matriculeInput.value.trim()
				const identity = identityInput.value.trim()

				const toastBootstrapErr = bootstrap.Toast.getOrCreateInstance(document.getElementById('err-toast'))
				const toastBootstrapSuccess = bootstrap.Toast.getOrCreateInstance(document.getElementById('success-toast'))


				if (matricule.length !== 3 || !matricule.startsWith("2")) {
					alert("Le matricule doit faire 3 caractères et doit commencer par 2 (Ex : 201)")
					return
				}

				if (identity.length < 3) {
					alert("Le nom RP doit faire au moins 3 caractères")
					return
				}
				
				if (`${matricule} | ${identity}` === user.rpname) {
					console.log("same name")
					$('#account-modal').modal('hide')
					return
				}

				await fetch(`/api/user/${user.id}`, {
					method: "PUT",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						matricule,
						identity
					})
				}).then((res) => res.json())
					.then((data) => {
						document.getElementById('no-rpname').style.display = "none"
						$('#toast-body-success').text(`Votre matricule et nom RP ont été sauvegardés avec succès`);
						toastBootstrapSuccess.show();
						$('#account-modal').modal('hide')
					}).catch((err) => {
						console.error(err);
						$('#toast-body-err').text(err.message);
						toastBootstrapErr.show();
					});
			})

			if (user.rpname) {
				document.getElementById('no-rpname').style.display = "none"

				matriculeInput.value = parseInt(user.rpname.split("|")[0])
				identityInput.value = user.rpname.split("|")[1]
			}

			if (!isAuthenticated) {
				window.location.replace("/auth/discord");
			}
		</script>
	</body>

</html>